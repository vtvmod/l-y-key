<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>KEY GAME VTVMOD</title>
  <style>
    body {
      background-color: #1a1a1a;
      color: white;
      font-family: Arial, sans-serif;
      text-align: center;
      padding: 20px;
    }
    .game-box {
      background: #222;
      padding: 20px;
      margin: 20px auto;
      max-width: 320px;
      border-radius: 12px;
      border: 3px solid;
      animation: glow 4.5s infinite alternate;
    }
    @keyframes glow {
      10% { border-color: #0000FF; }
      20% { border-color: #FF0000; }
      30% { border-color: #FF00FF; }
      40% { border-color: #FFD700; }
      50% { border-color: #00FF00; }
      60% { border-color: #00FFFF; }
      70% { border-color: #4B0082; }
    }
    .logo img {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      object-fit: cover;
      margin-bottom: 10px;
      border: 3px solid #FFD700;
    }
    button {
      background: #007bff;
      color: white;
      border: none;
      padding: 10px 18px;
      font-size: 16px;
      border-radius: 5px;
      cursor: pointer;
      margin-top: 10px;
    }
    button:hover { background: #0056b3; }
    #stepsLabel {
      font-size: 15px;
      color: #FFD700;
      margin: 10px 0;
      font-weight: bold;
    }
    #status { margin-top: 10px; font-size: 14px; color: #f1c40f; }
  </style>
</head>
<body>
  <h1>KEY GAME VTVMOD</h1>

  <div class="game-box">
    <!-- Ảnh game -->
    <div class="logo">
      <img src="https://play-lh.googleusercontent.com/SUo0gQMM3qQPPmBKHoABJH21zSNMFt-niK1LFg43HU4YWQwnswItylJguiJYftGmXQ96Bh4pzP6aVoeb5L9DQw=w5120-h2880-rw" alt="Liên Quân Mobile">
    </div>

    <h2>🎮 Liên Quân Mobile</h2>
    <p>Nhận Key Free (hết hạn lúc 00h)</p>

    <!-- Số lần vượt -->
    <div id="stepsLabel">➡️Số lần vượt: 2 </div>

    <!-- Nút nhận key -->
    <button id="getKeyBtn" onclick="getFreeKey()">🎁 Nhận KEY Free</button>
    
    <!-- Trạng thái -->
    <div id="status"></div>
  </div>

<script>
  const configUrl = "https://solanvuot-default-rtdb.asia-southeast1.firebasedatabase.app/config/redirect_mode.json";
  const stepsLabel = document.getElementById("stepsLabel");

function getDeviceId() {
  // Lấy deviceId từ localStorage nếu có
  let deviceId = localStorage.getItem("deviceId");
  if (!deviceId) {
    // Nếu chưa có thì tạo mới và lưu lại
    deviceId = "DEV_" + Math.random().toString(36).substring(2, 15);
    localStorage.setItem("deviceId", deviceId);
  }
  return deviceId;
}

async function createFreeKey() {
  const deviceId = getDeviceId();

  // reset sau 00h
  const now = new Date();
  const midnight = new Date();
  midnight.setHours(24, 0, 0, 0);
  const expiresIn = Math.floor((midnight - now) / 1000);

  // kiểm tra deviceId đã có key chưa
  const deviceUrl = `https://hqvkey-default-rtdb.firebaseio.com/device_keys/${deviceId}.json`;
  const deviceRes = await fetch(deviceUrl);
  const deviceData = await deviceRes.json();

  if (deviceData && deviceData.key) {
    // 🔑 nếu có key trong Firebase thì trả về key cũ
    return deviceData.key;
  }

  // nếu chưa có thì tạo mới
  const randomPart = Math.random().toString(36).substring(2, 12);
  const fullKey = "FREE_VTVMOD_" + randomPart;

  const keyBody = {
    activated_at: 0,
    devices: {},
    expires_after: expiresIn,
    max_devices: 1,
    deviceId: deviceId
  };

  // lưu key vào valid_keys
  const url = `https://hqvkey-default-rtdb.firebaseio.com/valid_keys/${fullKey}.json`;
  await fetch(url, { 
    method: "PUT", 
    headers: {"Content-Type": "application/json"}, 
    body: JSON.stringify(keyBody) 
  });

  // lưu map deviceId -> key
  const deviceBody = {
    key: fullKey,
    expires_after: expiresIn
  };
  await fetch(deviceUrl, { 
    method: "PUT", 
    headers: {"Content-Type": "application/json"}, 
    body: JSON.stringify(deviceBody) 
  });

  return fullKey;
}


  async function getRedirectMode() {
    try {
      const res = await fetch(configUrl);
      const data = await res.json();
      if (!data) return 2;
      const now = Date.now();
      if (data.expiresAt && now > data.expiresAt) return 2;
      return data.mode ?? 2;
    } catch {
      return 2;
    }
  }

  async function updateStepsLabel() {
    const mode = await getRedirectMode();
    let steps = 0;
    if (mode === 2) steps = 2;
    else if (mode === 1) steps = 1;
    else steps = 0;
    stepsLabel.innerText = `➡️ Số lần vượt: ${steps} `;
  }

  async function getFreeKey() {
  try {
    const btn = document.getElementById("getKeyBtn");
    btn.disabled = true;
    btn.innerText = "⏳ Đang xử lý...";
    const key = await createFreeKey();

    const xlink = "https://xlink.co/st?token=c83a755e-f56f-4591-802b-9a8b09aaa5d9&url=";
    const yeumoney = "https://yeumoney.com/QL_api.php?token=807449fbc75745c7df3acc6a0357b5b5c48b69b6daeb15877e6245a3c8ea0b36&url=";
    const xlinkNoBypass = "https://xlink.co/st?token=a207165a-b69b-487e-8317-6ff3f98b34cf&url=";

    const targetUrl = "https://hackergammer.online/GETKEY/key.html?key=" + key;

    const mode = await getRedirectMode();
    let finalUrl = targetUrl;

    if (mode === 2) {
      // 2 lớp
      if (Math.random() < 0.5) {
        finalUrl = xlink + encodeURIComponent(yeumoney + encodeURIComponent(targetUrl));
      } else {
        finalUrl = yeumoney + encodeURIComponent(xlink + encodeURIComponent(targetUrl));
      }
    } else if (mode === 1) {
      // 1 lớp ngẫu nhiên
      if (Math.random() < 0.5) {
        finalUrl = xlink + encodeURIComponent(targetUrl);
      } else {
        finalUrl = yeumoney + encodeURIComponent(targetUrl);
      }
    } else if (mode === 0) {
      // 0 lớp => vẫn qua link rút gọn đặc biệt
      finalUrl = xlinkNoBypass + encodeURIComponent(targetUrl);
    }

    window.location.href = finalUrl;
  } catch (e) {
    console.error(e);
  }
}


  updateStepsLabel();
  setInterval(updateStepsLabel, 300);
</script>

</body>
</html>
